<!DOCTYPE html>
<html ng-app="zombieApp" lang="english">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56478232-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-56478232-3');

      var errors = 1;

      // Track basic JavaScript errors
      window.addEventListener('error', function(e) {
          gtag('event', 'error', {
            'event_category': 'JS exception',
            'event_label': e.message + ": " + e.filename + ":  " + e.lineno,
            'value': errors++
          });
      });

      // Check URL parameters for save editor mode
      window.saveEditorMode = new URLSearchParams(window.location.search).has('sedit') || 
                              new URLSearchParams(window.location.search).get('editor') === 'true';
      console.log('Save editor mode:', window.saveEditorMode, 'URL:', window.location.search);
      
      // Test function to verify it's accessible
      window.testSaveEditor = function() {
        console.log('Test save editor function called!');
        
        // Simple modal test
        var modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
          align-items: center; justify-content: center; color: white;
        `;
        modal.innerHTML = `
          <div style="background: #333; padding: 20px; border-radius: 10px; text-align: center;">
            <h2>Save Editor Test</h2>
            <p>Save editor modal is working!</p>
            <button onclick="this.parentElement.parentElement.remove();" style="margin: 10px; padding: 10px 20px;">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        return true;
      };
      
      // Simple function to open save editor
      window.openSaveEditor = function() {
        console.log('Opening save editor...');
        // Check if we can access the game model
        var appElement = document.querySelector('[ng-controller="ZombieController as zm"]');
        console.log('App element found:', !!appElement);
        if (appElement) {
          var scope = angular.element(appElement).scope();
          console.log('Scope found:', !!scope);
          console.log('ZM found:', !!(scope && scope.zm));
          console.log('Model found:', !!(scope && scope.zm && scope.zm.model));
          if (scope && scope.zm && scope.zm.model) {
            // Create a simple save editor interface
            showSaveEditorDialog(scope.zm.model);
          } else {
            alert('Unable to access game data. Please start a game first.');
          }
        } else {
          alert('Unable to access game controller.');
        }
      };
      
      // Save editor dialog function
      window.showSaveEditorDialog = function(gameModel) {
        // Create modal dialog
        var modal = document.createElement('div');
        modal.id = 'save-editor-modal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
          align-items: center; justify-content: center;
        `;
        
        var dialog = document.createElement('div');
        dialog.style.cssText = `
          background: #2a2a2a; color: #fff; padding: 20px; border-radius: 10px; 
          max-width: 80%; max-height: 80%; overflow-y: auto; border: 2px solid #444;
        `;
        
        dialog.innerHTML = `
          <h2>Incremancer Save Editor</h2>
          <div style="margin-bottom: 20px;">
            <button onclick="closeSaveEditor()">Close</button>
            <button onclick="exportSaveAsJson()">Export JSON</button>
            <button onclick="refreshSaveEditor()">Refresh</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h3>Resources</h3>
              <div style="margin-bottom: 10px;">
                <label>Blood: </label>
                <input type="number" id="edit-blood" value="${gameModel.persistentData.blood || 0}" style="width: 100px;">
                <button onclick="setResource('blood')">Set</button>
              </div>
              <div style="margin-bottom: 10px;">
                <label>Brains: </label>
                <input type="number" id="edit-brains" value="${gameModel.persistentData.brains || 0}" style="width: 100px;">
                <button onclick="setResource('brains')">Set</button>
              </div>
              <div style="margin-bottom: 10px;">
                <label>Bones: </label>
                <input type="number" id="edit-bones" value="${gameModel.persistentData.bones || 0}" style="width: 100px;">
                <button onclick="setResource('bones')">Set</button>
              </div>
              <div style="margin-bottom: 10px;">
                <label>Parts: </label>
                <input type="number" id="edit-parts" value="${gameModel.persistentData.parts || 0}" style="width: 100px;">
                <button onclick="setResource('parts')">Set</button>
              </div>
              <div style="margin-bottom: 10px;">
                <label>Level: </label>
                <input type="number" id="edit-level" value="${gameModel.level || 1}" style="width: 100px;">
                <button onclick="setLevel()">Set</button>
              </div>
            </div>
            
            <div>
              <h3>Quick Actions</h3>
              <button onclick="giveMaxResources()" style="margin: 5px;">Max Resources</button>
              <button onclick="unlockAllUpgrades()" style="margin: 5px;">Unlock All Upgrades</button>
              <button onclick="maxAllConstructions()" style="margin: 5px;">Max Constructions</button>
              <button onclick="generateItems()" style="margin: 5px;">Generate 10 Items</button>
              
              <h3>Upgrade Editor</h3>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #555; padding: 10px;">
                <div id="upgrades-list"></div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <h3>JSON Editor</h3>
            <textarea id="json-editor" style="width: 100%; height: 150px; font-family: monospace; background: #333; color: #fff; border: 1px solid #555;" placeholder="Export JSON first to see save data"></textarea>
            <div style="margin-top: 10px;">
              <button onclick="applyJsonChanges()">Apply JSON Changes</button>
              <button onclick="resetJsonEditor()">Reset JSON</button>
            </div>
          </div>
          
          <div id="editor-status" style="margin-top: 10px; padding: 10px; background: #444; border-radius: 5px; display: none;"></div>
        `;
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // Store reference to game model
        window.currentGameModel = gameModel;
        
        // Populate upgrades list
        populateUpgradesList();
        
        // Focus on modal
        modal.onclick = function(e) {
          if (e.target === modal) closeSaveEditor();
        };
      };
      
      // Save editor functions
      window.closeSaveEditor = function() {
        var modal = document.getElementById('save-editor-modal');
        if (modal) modal.remove();
        window.currentGameModel = null;
      };
      
      window.refreshSaveEditor = function() {
        if (window.currentGameModel) {
          closeSaveEditor();
          showSaveEditorDialog(window.currentGameModel);
        }
      };
      
      window.setResource = function(resourceName) {
        var input = document.getElementById('edit-' + resourceName);
        var value = parseInt(input.value);
        if (!isNaN(value) && value >= 0) {
          window.currentGameModel.persistentData[resourceName] = value;
          window.currentGameModel.saveData();
          showStatus(resourceName.charAt(0).toUpperCase() + resourceName.slice(1) + ' set to ' + value, 'success');
        }
      };
      
      window.setLevel = function() {
        var input = document.getElementById('edit-level');
        var value = parseInt(input.value);
        if (!isNaN(value) && value > 0) {
          window.currentGameModel.level = value;
          window.currentGameModel.persistentData.levelUnlocked = Math.max(window.currentGameModel.persistentData.levelUnlocked || 1, value);
          window.currentGameModel.saveData();
          showStatus('Level set to ' + value, 'success');
        }
      };
      
      window.giveMaxResources = function() {
        var model = window.currentGameModel;
        model.persistentData.blood = 999999999;
        model.persistentData.brains = 999999999;
        model.persistentData.bones = 999999999;
        model.persistentData.parts = 999999999;
        model.saveData();
        showStatus('All resources maxed!', 'success');
        refreshSaveEditor();
      };
      
      window.unlockAllUpgrades = function() {
        var model = window.currentGameModel;
        if (model.persistentData.upgrades) {
          for (var i = 0; i < model.persistentData.upgrades.length; i++) {
            model.persistentData.upgrades[i].rank = Math.max(model.persistentData.upgrades[i].rank, 1);
          }
          model.saveData();
          showStatus('All upgrades unlocked!', 'success');
          populateUpgradesList();
        }
      };
      
      window.maxAllConstructions = function() {
        var model = window.currentGameModel;
        if (model.persistentData.constructions) {
          for (var i = 0; i < model.persistentData.constructions.length; i++) {
            model.persistentData.constructions[i].rank = 1;
            model.persistentData.constructions[i].effect = 1;
          }
          model.saveData();
          showStatus('All constructions maxed!', 'success');
        }
      };
      
      window.generateItems = function() {
        var model = window.currentGameModel;
        if (!model.persistentData.skeleton) {
          model.persistentData.skeleton = { items: [], level: 1 };
        }
        if (!model.persistentData.skeleton.items) {
          model.persistentData.skeleton.items = [];
        }
        
        var baseLevel = model.persistentData.skeleton.level || 1;
        var items = model.persistentData.skeleton.items;
        
        for (var i = 0; i < 10; i++) {
          var item = generateRandomItem(baseLevel, items.length + i + 1);
          items.push(item);
        }
        
        model.saveData();
        showStatus('Generated 10 random items!', 'success');
      };
      
      window.generateRandomItem = function(level, id) {
        var rarities = [1, 2, 3, 4];
        var weights = [60, 24, 12.8, 3.2];
        var rarity = weightedChoice(rarities, weights);
        
        return {
          id: id,
          l: level,
          s: Math.floor(Math.random() * 7) + 1, // Item type 1-7
          r: rarity,
          p: Math.floor(Math.random() * (rarity === 4 ? 5 : rarity === 3 ? 8 : rarity === 2 ? 9 : 11)) + 1,
          e: rarity > 1 ? [Math.floor(Math.random() * 5) + 1] : [],
          se: rarity === 4 ? [Math.floor(Math.random() * 8) + 1] : [],
          q: false
        };
      };
      
      window.weightedChoice = function(choices, weights) {
        var total = weights.reduce(function(a, b) { return a + b; }, 0);
        var random = Math.random() * total;
        var weightSum = 0;
        
        for (var i = 0; i < choices.length; i++) {
          weightSum += weights[i];
          if (random <= weightSum) {
            return choices[i];
          }
        }
        return choices[choices.length - 1];
      };
      
      window.populateUpgradesList = function() {
        var upgradesList = document.getElementById('upgrades-list');
        if (!upgradesList || !window.currentGameModel.persistentData.upgrades) return;
        
        var upgradeNames = [
          'Bloodthirst', 'Like Leather', 'Cold Storage', 'Recycling is Cool',
          'Your Soul is Mine', 'Infected Bite', 'Detonate', 'Gigazombies',
          'Sharpened Teeth', 'Thick Skull', 'Razor Claws', 'Battle Hardened',
          'Blazing Speed', 'Spit it Out', 'Runic Syphon', 'Killer Instinct',
          'Tough as Nails', 'Faster Harpies', 'Energy Rush', 'Master Summoner',
          'Primal Reflexes', 'Blood Harvest', 'Unholy Construction', 'Infected Corpse',
          'Energy Charge', 'What Doesn\\'t Kill You', 'One is Never Enough', 'Tank Buster',
          'Improved Spikes', 'Bone Throne', 'Crown of Bones', 'Bonebarrows',
          'Bone Reinforced Tanks', 'Brain Cage', 'Earth Freeze', 'Plague Armor',
          'Bulletproof', 'Bombs Away', 'Extra Limbs', 'Big Boned',
          'Blood Storage', 'Blood Rate', 'Brain Storage', 'Brain Rate',
          'Bone Rate', 'A Small Investment', 'Time Warp', 'Master of Death',
          'Parts Rate', 'Auto Construction', 'Graveyard Health', 'Auto Shop',
          'Talent Point'
        ];
        
        var html = '';
        for (var i = 0; i < window.currentGameModel.persistentData.upgrades.length; i++) {
          var upgrade = window.currentGameModel.persistentData.upgrades[i];
          var name = upgradeNames[i] || 'Unknown ' + i;
          html += '<div style="margin: 2px 0; font-size: 12px;">' +
                  '<span style="display: inline-block; width: 150px;">' + name + ':</span>' +
                  '<input type="number" id="upgrade-' + i + '" value="' + upgrade.rank + '" style="width: 50px;">' +
                  '<button onclick="setUpgrade(' + i + ')" style="margin-left: 5px;">Set</button>' +
                  '</div>';
        }
        upgradesList.innerHTML = html;
      };
      
      window.setUpgrade = function(index) {
        var input = document.getElementById('upgrade-' + index);
        var value = parseInt(input.value);
        if (!isNaN(value) && value >= 0) {
          window.currentGameModel.persistentData.upgrades[index].rank = value;
          window.currentGameModel.saveData();
          showStatus('Upgrade ' + index + ' set to rank ' + value, 'success');
        }
      };
      
      window.exportSaveAsJson = function() {
        var jsonEditor = document.getElementById('json-editor');
        if (jsonEditor && window.currentGameModel) {
          jsonEditor.value = JSON.stringify(window.currentGameModel.persistentData, null, 2);
          showStatus('Save data exported to JSON editor', 'success');
        }
      };
      
      window.resetJsonEditor = function() {
        exportSaveAsJson();
      };
      
      window.applyJsonChanges = function() {
        var jsonEditor = document.getElementById('json-editor');
        if (jsonEditor && window.currentGameModel) {
          try {
            var newData = JSON.parse(jsonEditor.value);
            Object.assign(window.currentGameModel.persistentData, newData);
            window.currentGameModel.saveData();
            showStatus('JSON changes applied successfully!', 'success');
            refreshSaveEditor();
          } catch (error) {
            showStatus('Error applying JSON: ' + error.message, 'error');
          }
        }
      };
      
      window.showStatus = function(message, type) {
        var status = document.getElementById('editor-status');
        if (status) {
          status.textContent = message;
          status.style.display = 'block';
          status.style.backgroundColor = type === 'success' ? '#4a4' : '#a44';
          setTimeout(function() {
            status.style.display = 'none';
          }, 3000);
        }
      };
      
      // Hide/show save editor section based on URL parameter
      window.addEventListener('DOMContentLoaded', function() {
        function toggleSaveEditorSection() {
          var section = document.getElementById('save-editor-section');
          if (section) {
            section.style.display = window.saveEditorMode ? 'block' : 'none';
          }
        }
        
        function setupSaveEditor() {
          var btn = document.getElementById('open-save-editor-btn');
          if (btn && !btn.hasAttribute('data-setup')) {
            btn.setAttribute('data-setup', 'true');
            btn.onclick = function() {
              openSaveEditorModal();
            };
          }
        }
        
        // Check periodically since Angular may load templates asynchronously
        var checkInterval = setInterval(function() {
          var section = document.getElementById('save-editor-section');
          var btn = document.getElementById('open-save-editor-btn');
          
          if (section) {
            toggleSaveEditorSection();
          }
          
          if (btn) {
            setupSaveEditor();
            if (section) {
              clearInterval(checkInterval);
            }
          }
        }, 500);
        
        // Also set a timeout to stop checking after 10 seconds
        setTimeout(function() {
          clearInterval(checkInterval);
        }, 10000);
      });
      
      // Save Editor Modal Function
      window.openSaveEditorModal = function() {
        // Remove existing modal if any
        var existingModal = document.getElementById('save-editor-modal');
        if (existingModal) {
          existingModal.remove();
        }
        
        var modal = document.createElement('div');
        modal.id = 'save-editor-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white;';
        
        var saveData = localStorage.getItem('zombieGameSave');
        var decodedData = '';
        
        if (saveData && typeof LZString !== 'undefined') {
          try {
            decodedData = LZString.decompressFromEncodedURIComponent(saveData);
          } catch(e) {
            decodedData = 'Error decoding save data: ' + e.message;
          }
        } else {
          decodedData = 'No save data found or LZString not available';
        }
        
        var dialogHtml = '<div style="background: #333; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow-y: auto;">' +
          '<h2 style="color: #fff; margin-top: 0;">Incremancer Save Editor</h2>' +
          '<p style="color: #ccc;">Edit your save data as JSON. Be careful - invalid JSON will break your save!</p>' +
          '<textarea style="width: 100%; max-width: 600px; height: 300px; font-family: monospace; background: #222; color: #fff; border: 1px solid #555; padding: 10px;" id="save-data-editor">' + (decodedData || 'No data') + '</textarea>' +
          '<div style="margin-top: 15px;">' +
          '<button style="margin: 5px; padding: 10px 15px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="closeSaveEditor();">Close</button> ' +
          '<button style="margin: 5px; padding: 10px 15px; background: #4a4; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="applySaveChanges();">Apply Changes</button> ' +
          '<button style="margin: 5px; padding: 10px 15px; background: #44a; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="maxResources();">Max Resources</button>' +
          '</div></div>';
        
        modal.innerHTML = dialogHtml;
        document.body.appendChild(modal);
        
        modal.onclick = function(e) {
          if (e.target === modal) modal.remove();
        };
      };
      
      // Save Editor Functions
      window.closeSaveEditor = function() {
        var modal = document.getElementById('save-editor-modal');
        if (modal) modal.remove();
      };
      
      window.applySaveChanges = function() {
        var textarea = document.getElementById('save-data-editor');
        if (!textarea) return;
        
        try {
          var newData = JSON.parse(textarea.value);
          if (typeof LZString !== 'undefined') {
            localStorage.setItem('zombieGameSave', LZString.compressToEncodedURIComponent(textarea.value));
            alert('Save data updated! Please refresh the page to see changes.');
          } else {
            alert('LZString library not available. Cannot save data.');
          }
        } catch(e) {
          alert('Error parsing JSON: ' + e.message);
        }
      };
      
      window.maxResources = function() {
        var textarea = document.getElementById('save-data-editor');
        if (!textarea) return;
        
        try {
          var current = JSON.parse(textarea.value);
          current.blood = 999999999;
          current.brains = 999999999;
          current.bones = 999999999;
          current.parts = 999999999;
          if (current.levelUnlocked) {
            current.levelUnlocked = Math.max(current.levelUnlocked, 50);
          }
          textarea.value = JSON.stringify(current, null, 2);
          alert('Resources maxed! Click "Apply Changes" to save.');
        } catch(e) {
          alert('Error modifying resources: ' + e.message);
        }
      };
    </script>

    <!-- Development Debugging Script -->
    <script>
      // Development environment detection
      window.isDevelopment = location.hostname === 'localhost' || 
                           location.hostname === '127.0.0.1' || 
                           location.hostname === '0.0.0.0' ||
                           location.port === '8080';
      
      if (window.isDevelopment) {
        console.log('üöÄ Incremancer Development Mode Enabled');
        console.log('üìç Host:', location.host);
        console.log('üîß Debug tools available:');
        console.log('  - window.debugGame() - Access game state');
        console.log('  - window.debugAngular() - Access Angular scope');
        console.log('  - window.debugPixi() - Access PixiJS info');
        
        // Enhanced error logging for development
        window.addEventListener('error', function(e) {
          console.error('üêõ JavaScript Error:', {
            message: e.message,
            filename: e.filename,
            line: e.lineno,
            column: e.colno,
            error: e.error,
            stack: e.error ? e.error.stack : null
          });
        });

        // Log unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
          console.error('üö® Unhandled Promise Rejection:', e.reason);
        });

        // Debug helper functions
        window.debugGame = function() {
          console.log('üéÆ Game State:', window.Incremancer || 'Not available');
          return window.Incremancer;
        };

        window.debugAngular = function() {
          try {
            const scope = angular.element(document.body).scope();
            console.log('üìê Angular Scope:', scope);
            return scope;
          } catch(e) {
            console.warn('Angular scope not available:', e);
          }
        };

        window.debugPixi = function() {
          console.log('üé® PixiJS Info:', {
            version: window.PIXI ? window.PIXI.VERSION : 'Not loaded',
            renderer: window.PIXI ? 'Available' : 'Not available'
          });
          return window.PIXI;
        };

        // Performance monitoring
        window.addEventListener('load', function() {
          setTimeout(function() {
            const perf = performance.timing;
            const loadTime = perf.loadEventEnd - perf.navigationStart;
            console.log('‚ö° Page Load Time:', loadTime + 'ms');
          }, 100);
        });
      }
    </script>
    <title>Incremancer</title>
    <meta name="description" content="Zombie necromancer idle game">
    <meta name="keywords" content="zombie,game,idle,javascript">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex">
    <meta name="theme-color" content="#104510" />
    <meta charset="utf-8"/>
    <link rel="manifest" href="manifest.json">
    <script src='https://download.playfab.com/PlayFabClientApi.js'></script>
    <script src='https://www.kongregate.com/javascripts/kongregate_api.js'></script>
    <script src="js/lz-string.min.js"></script>
    <script src="js/pixi-legacy.min.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="dist/bundle.js"></script>
    <script>
      // Extend the Angular app with save editor functionality
      angular.module('zombieApp').directive('saveEditorMenu', function() {
        return {
          templateUrl: './templates/saveeditormenu.html'
        };
      });

      // Add save editor functionality to the controller
      angular.module('zombieApp').run(['$rootScope', function($rootScope) {
        // Check if save editor mode is enabled
        $rootScope.saveEditorMode = window.saveEditorMode;
      }]);

      // Extend ZombieController with save editor functionality
      angular.module('zombieApp').run(['$timeout', function($timeout) {
        $timeout(function() {
          var appElement = document.querySelector('[ng-controller="ZombieController as zm"]');
          if (appElement) {
            var scope = angular.element(appElement).scope();
            if (scope && scope.zm) {
              // Add save editor mode flag
              scope.zm.saveEditorMode = window.saveEditorMode;
              
              // Add function to open save editor
              scope.zm.openSaveEditor = function() {
                scope.zm.closeSidePanels();
                scope.zm.sidePanels.saveEditor = true;
                scope.zm.sidePanels.open = true;
              };
              
              // Initialize the save editor controller
              var saveEditorController = new SaveEditorController(scope);
            }
          }
        }, 1000);
      }]);

      // Save Editor Controller function
      function SaveEditorController($scope) {
        var self = this;
        
        // Initialize save editor state
        self.showJsonEditor = false;
        self.jsonData = '';
        self.message = '';
        self.messageType = '';
        
        // Resource editor
        self.resources = {
          blood: 0,
          brains: 0,
          bones: 0,
          parts: 0
        };
        
        // Level editor
        self.levelData = {
          level: 1,
          skeletonLevel: 1
        };
        
        // Upgrade editor
        self.selectedUpgrade = null;
        self.upgradeRank = 0;
        self.upgradesList = [];
        
        // Construction editor
        self.selectedConstruction = null;
        self.constructionRank = 0;
        self.constructionEffect = 0;
        self.constructionsList = [];
        
        // Item generator
        self.itemsToGenerate = 1;
        
        // Export save as JSON
        self.exportSaveToJson = function() {
          try {
            var saveData = JSON.parse(LZString.decompressFromEncodedURIComponent($scope.zm.model.blob.slice(0, $scope.zm.model.blob.size)));
            self.jsonData = JSON.stringify(saveData, null, 2);
            var blob = new Blob([self.jsonData], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'incremancer_save.json';
            a.click();
            URL.revokeObjectURL(url);
            self.showMessage('Save exported successfully!', 'success');
          } catch (error) {
            self.showMessage('Error exporting save: ' + error.message, 'error');
          }
        };
        
        // Toggle JSON editor
        self.toggleJsonEditor = function() {
          self.showJsonEditor = !self.showJsonEditor;
          if (self.showJsonEditor) {
            self.resetJsonData();
          }
        };
        
        // Reset JSON data to current save
        self.resetJsonData = function() {
          try {
            var saveData = $scope.zm.model.persistentData;
            self.jsonData = JSON.stringify(saveData, null, 2);
            self.loadCurrentValues();
          } catch (error) {
            self.showMessage('Error loading save data: ' + error.message, 'error');
          }
        };
        
        // Load current values into editors
        self.loadCurrentValues = function() {
          var data = $scope.zm.model.persistentData;
          self.resources.blood = data.blood || 0;
          self.resources.brains = data.brains || 0;
          self.resources.bones = data.bones || 0;
          self.resources.parts = data.parts || 0;
          self.levelData.level = $scope.zm.model.level || 1;
          
          // Load upgrades list
          if (data.upgrades) {
            self.upgradesList = data.upgrades.map(function(upgrade, index) {
              return {
                id: index,
                name: self.getUpgradeName(index),
                rank: upgrade.rank
              };
            });
          }
          
          // Load constructions list
          if (data.constructions) {
            self.constructionsList = data.constructions.map(function(construction, index) {
              return {
                id: index,
                name: self.getConstructionName(index),
                rank: construction.rank,
                effect: construction.effect
              };
            });
          }
        };
        
        // Apply JSON changes
        self.applyJsonChanges = function() {
          try {
            var newData = JSON.parse(self.jsonData);
            Object.assign($scope.zm.model.persistentData, newData);
            $scope.zm.model.saveData();
            self.loadCurrentValues();
            self.showMessage('Changes applied successfully!', 'success');
          } catch (error) {
            self.showMessage('Error applying changes: ' + error.message, 'error');
          }
        };
        
        // Set resource value
        self.setResource = function(resourceName) {
          var value = self.resources[resourceName];
          if (value >= 0) {
            $scope.zm.model.persistentData[resourceName] = parseInt(value);
            $scope.zm.model.saveData();
            self.showMessage(resourceName.charAt(0).toUpperCase() + resourceName.slice(1) + ' set to ' + value, 'success');
          }
        };
        
        // Set level
        self.setLevel = function() {
          if (self.levelData.level > 0) {
            $scope.zm.model.level = parseInt(self.levelData.level);
            $scope.zm.model.saveData();
            self.showMessage('Level set to ' + self.levelData.level, 'success');
          }
        };
        
        // Set skeleton level
        self.setSkeletonLevel = function() {
          if (self.levelData.skeletonLevel > 0 && $scope.zm.model.persistentData.skeleton) {
            $scope.zm.model.persistentData.skeleton.level = parseInt(self.levelData.skeletonLevel);
            $scope.zm.model.saveData();
            self.showMessage('Skeleton level set to ' + self.levelData.skeletonLevel, 'success');
          }
        };
        
        // Set upgrade rank
        self.setUpgradeRank = function() {
          if (self.selectedUpgrade && self.upgradeRank >= 0) {
            $scope.zm.model.persistentData.upgrades[self.selectedUpgrade.id].rank = parseInt(self.upgradeRank);
            $scope.zm.model.saveData();
            self.showMessage(self.selectedUpgrade.name + ' rank set to ' + self.upgradeRank, 'success');
            self.loadCurrentValues();
          }
        };
        
        // Set construction values
        self.setConstructionValues = function() {
          if (self.selectedConstruction && self.constructionRank >= 0 && self.constructionEffect >= 0) {
            var construction = $scope.zm.model.persistentData.constructions[self.selectedConstruction.id];
            construction.rank = parseInt(self.constructionRank);
            construction.effect = parseInt(self.constructionEffect);
            $scope.zm.model.saveData();
            self.showMessage(self.selectedConstruction.name + ' values updated', 'success');
            self.loadCurrentValues();
          }
        };
        
        // Generate items
        self.generateItems = function() {
          if (self.itemsToGenerate > 0 && self.itemsToGenerate <= 50) {
            var items = $scope.zm.model.persistentData.skeleton.items || [];
            var baseLevel = $scope.zm.model.persistentData.skeleton.level || 1;
            
            for (var i = 0; i < self.itemsToGenerate; i++) {
              var item = self.generateRandomItem(baseLevel, items.length + i + 1);
              items.push(item);
            }
            
            $scope.zm.model.persistentData.skeleton.items = items;
            $scope.zm.model.saveData();
            self.showMessage('Generated ' + self.itemsToGenerate + ' items', 'success');
          }
        };
        
        // Generate random item
        self.generateRandomItem = function(level, id) {
          var rarities = [1, 2, 3, 4];
          var weights = [60, 24, 12.8, 3.2];
          var rarity = self.weightedChoice(rarities, weights);
          
          return {
            id: id,
            l: level,
            s: Math.floor(Math.random() * 7) + 1, // Item type 1-7
            r: rarity,
            p: Math.floor(Math.random() * (rarity === 4 ? 5 : rarity === 3 ? 8 : rarity === 2 ? 9 : 11)) + 1,
            e: rarity > 1 ? [Math.floor(Math.random() * 5) + 1] : [],
            se: rarity === 4 ? [Math.floor(Math.random() * 8) + 1] : [],
            q: false
          };
        };
        
        // Weighted choice helper
        self.weightedChoice = function(choices, weights) {
          var total = weights.reduce(function(a, b) { return a + b; }, 0);
          var random = Math.random() * total;
          var weightSum = 0;
          
          for (var i = 0; i < choices.length; i++) {
            weightSum += weights[i];
            if (random <= weightSum) {
              return choices[i];
            }
          }
          return choices[choices.length - 1];
        };
        
        // Show message
        self.showMessage = function(msg, type) {
          self.message = msg;
          self.messageType = type;
          setTimeout(function() {
            self.message = '';
            $scope.$apply();
          }, 3000);
        };
        
        // Get upgrade name by index
        self.getUpgradeName = function(index) {
          var names = [
            'Bloodthirst', 'Like Leather', 'Cold Storage', 'Recycling is Cool',
            'Your Soul is Mine', 'Infected Bite', 'Detonate', 'Gigazombies',
            'Sharpened Teeth', 'Thick Skull', 'Razor Claws', 'Battle Hardened',
            'Blazing Speed', 'Spit it Out', 'Runic Syphon', 'Killer Instinct',
            'Tough as Nails', 'Faster Harpies', 'Energy Rush', 'Master Summoner',
            'Primal Reflexes', 'Blood Harvest', 'Unholy Construction', 'Infected Corpse',
            'Energy Charge', 'What Doesn\'t Kill You', 'One is Never Enough', 'Tank Buster',
            'Improved Spikes', 'Bone Throne', 'Crown of Bones', 'Bonebarrows',
            'Bone Reinforced Tanks', 'Brain Cage', 'Earth Freeze', 'Plague Armor',
            'Bulletproof', 'Bombs Away', 'Extra Limbs', 'Big Boned',
            'Blood Storage', 'Blood Rate', 'Brain Storage', 'Brain Rate',
            'Bone Rate', 'A Small Investment', 'Time Warp', 'Master of Death',
            'Parts Rate', 'Auto Construction', 'Graveyard Health', 'Auto Shop',
            'Talent Point'
          ];
          return names[index] || 'Unknown Upgrade ' + index;
        };
        
        // Get construction name by index
        self.getConstructionName = function(index) {
          var names = [
            'Cursed Graveyard', 'Perimeter Fence', 'Bigger Fence', 'Plague Workshop',
            'Crypt', 'Bone Fort', 'Bone Fortress', 'Plague Spikes',
            'Spell Tower', 'Runesmith', 'Bone Citadel', 'Accursed Aviary',
            'Zombie Cage 1', 'Zombie Cage 2', 'Zombie Cage 3', 'Zombie Cage 4',
            'Zombie Cage 5', 'Plague Laboratory', 'Part Factory', 'Creature Factory',
            'Bottomless Pit', 'Harpy Outfitter'
          ];
          return names[index] || 'Unknown Construction ' + index;
        };
        
        // Initialize
        self.loadCurrentValues();
        
        // Attach to scope
        $scope.zm.saveEditor = self;
      }
    </script>
    <link rel="stylesheet" type="text/css" href="zombiemancer.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
  </head>
  <body ng-controller="ZombieController as zm">
    <div class="message" ng-if="zm.message">
      <p>{{zm.message}}</p>
    </div>
      
    <div class="stats {{zm.model.persistentData.zoomButtons ? 'zoom' : ''}}">
      <label>Level: {{zm.model.level}}</label>
      <button ng-click="zm.showStats = !zm.showStats" class="{{zm.showStats ? 'active' : ''}}">Stats</button>
      <label>Humans: {{zm.model.getHumanCount()}}</label>
      <label>Zombies: {{zm.model.zombieCount}}</label>
      <label ng-if="zm.model.constructions.monsterFactory">Creatures: {{zm.model.creatureCount}} / {{zm.model.creatureLimit}}</label>
      <label ng-if="zm.model.persistentData.showfps">FPS: {{zm.model.frameRate|whole}}</label>
    </div>

    <div class="resources">
      <label class="energy">Energy:<span class="value">{{zm.model.energy|decimal}} / {{zm.model.energyMax|whole}}</span><span class="percent" ng-style="{'width':zm.energyPercent() + '%'}"></span></label>
      <label class="blood">Blood:<span class="value">{{zm.model.persistentData.blood|whole}} / {{zm.model.bloodMax|whole}}</span><span class="percent" ng-style="{'width':zm.bloodPercent() + '%'}"></span></label>
      <label class="brains">Brains:<span class="value">{{zm.model.persistentData.brains|whole}} / {{zm.model.brainsMax|whole}}</span><span class="percent" ng-style="{'width':zm.brainsPercent() + '%'}"></span></label>
      <label class="bones" ng-if="zm.model.constructions.graveyard || zm.model.persistentData.bones > 0">Bones:<span class="value">{{zm.model.persistentData.bones|whole}}</span></label>
      <label class="parts" ng-if="zm.model.constructions.factory || zm.model.persistentData.parts > 0">Parts:<span class="value">{{zm.model.persistentData.parts|whole}}</span></label>
      <div class="spells">
        <button ng-repeat="spell in zm.spells.getUnlockedSpells()" ng-click="zm.spells.castSpell(spell)" class="spell {{spell.active ? 'active' : (spell.onCooldown ? 'cooldown' : '')}}" ng-disabled="spell.onCooldown || spell.energyCost > zm.model.energy">
          <span class="icon">{{spell.name}}</span>
          <span class="timer" ng-if="spell.active || spell.onCooldown">{{spell.active ? spell.timer : spell.cooldownLeft|whole}}</span>
          <span class="tooltip" ng-if="!spell.active && !spell.onCooldown">{{spell.tooltip}}</span>
        </button>
        <div class="skeleton" ng-if="zm.model.persistentData.allTimeHighestLevel >= 50" ng-click="zm.skeletonMenu.show()">
          <div class="bg" id="skeleton"></div>
          <div class="xp">
            <span ng-style="{'height': zm.skeletonMenu.xpPercent() + '%'}"></span>
          </div>
          <div class="lvl" ng-if="zm.skeleton().skeletons > 0 && zm.skeletonMenu.isAlive()">
            lvl {{zm.skeleton().level}}
          </div>
          <div class="lvl dead" ng-if="zm.skeleton().skeletons > 0 && !zm.skeletonMenu.isAlive()">
            DEAD: {{zm.skeletonMenu.timer()}}
          </div>
        </div>
      </div>
    </div>

    <div class="buttons {{zm.sidePanels.open ? 'open' : ''}}">
        <button ng-click="zm.openSidePanel('shop');" class="{{zm.sidePanels.shop ? 'active' : ''}}">Shop</button>
        <button ng-click="zm.openSidePanel('construction');" ng-if="zm.model.construction" class="{{zm.sidePanels.construction ? 'active' : ''}}"><span ng-if="zm.model.persistentData.currentConstruction" class="tag">{{zm.constructionPercent()}}%</span>Construction</button>
        <button ng-click="zm.openSidePanel('graveyard');" ng-if="zm.model.constructions.graveyard" class="{{zm.sidePanels.graveyard ? 'active' : ''}}">Graveyard</button>
        <button ng-click="zm.openSidePanel('factory');" ng-if="zm.model.constructions.factory" class="{{zm.sidePanels.factory ? 'active' : ''}}">Factory</button>
        <button ng-click="zm.openSidePanel('runesmith');" ng-if="zm.model.constructions.runesmith" class="{{zm.sidePanels.runesmith ? 'active' : ''}}{{zm.canShatter() ? 'shatter' : ''}}">Runesmith</button>
        <button ng-click="zm.openSidePanel('prestige');" ng-if="zm.isShowPrestige()" class="{{zm.sidePanels.prestige ? 'active' : ''}}" id="prestige-button"><div id="prestige-bg"></div>Prestige</button>
        <button ng-click="zm.openSidePanel('options');" class="{{zm.sidePanels.options ? 'active' : ''}}">Options</button>
        <button ng-click="zm.levelSelect.show()" class="{{zm.levelSelect.shown ? 'active' : ''}}" ng-if="zm.levelSelect.showButton()">Level Select</button>
    </div>

    <div class="zoom-buttons" ng-if="zm.model.persistentData.zoomButtons">
      <button ng-click="zm.zoom(-1);">-</button>
      <button ng-click="zm.resetZoom();">Reset</button>
      <button ng-click="zm.zoom(+1);">+</button>
    </div>
    
    
    <shop-menu></shop-menu>
    <construction-menu></construction-menu>
    <graveyard-menu></graveyard-menu>
    <factory-menu></factory-menu>
    <runesmith-menu></runesmith-menu>
    <champions-hold-menu></champions-hold-menu>
    <prestige-menu></prestige-menu>
    <options-menu></options-menu>
    <save-editor-menu></save-editor-menu>
    <level-select></level-select>
    <level-stats></level-stats>

    <div class="end-level confirm" ng-if="zm.confirmCallback">
      <div><label>{{zm.confirmMessage}}</label></div>
      <button ng-click="zm.confirmCallback();">Yes</button><button ng-click="zm.confirmCancel();">No</button>
    </div>

    <div class="start-game" ng-if="zm.model.currentState == zm.model.states.startGame">
      <h2>Incremancer</h2>
      <h4>Take control of a horde of zombies to ravage small towns</h4>
      <ul>
        <li ng-repeat="text in zm.howToPlay">{{text}}</li>
      </ul>
      <a href="https://discord.gg/TxPyNDh" target="_blank">Join the Discord - https://discord.gg/TxPyNDh</a>
      <h3 ng-if="zm.model.offlineMessage">{{zm.model.offlineMessage}}</h3>
      <button ng-click="zm.startGame();">Start Level {{zm.model.level}}</button>
    </div>

    <div class="end-level" ng-if="zm.model.currentState == zm.model.states.failed">
      <h2>Level {{zm.model.level}} Failed</h2>
      <h4>You have been defeated</h4>
      <button ng-click="zm.model.startLevel(zm.model.level - 1);">Go back to Level {{zm.model.level - 1}}</button>
      <button ng-click="zm.model.startLevel(zm.model.level);">Retry Level {{zm.model.level}}</button>
    </div>

    <div class="end-level" ng-if="zm.model.currentState == zm.model.states.levelCompleted">
      <h2>Level {{zm.model.level}} Complete</h2>
      <h4>All the humans are either dead or undead!</h4>
      <h4 ng-if="zm.model.prestigePointsEarned > 0">You have earned {{zm.model.prestigePointsEarned}} prestige points</h4>
      <h4 ng-if="zm.model.endLevelBones" style="margin:1em">Your bone collectors have gathered the remaining {{zm.model.endLevelBones}} bones from the town</h4>
      <button ng-click="zm.nextLevel();">Start Level {{zm.model.level + 1}}</button>
    </div>

    <div class="start-game" ng-if="zm.model.currentState == zm.model.states.prestiged">
      <h2>You have prestiged!</h2>
      <p>It's time to start from the beginning again, but this time stronger and faster.</p>
      <h4>You have {{zm.model.persistentData.prestigePointsToSpend}} prestige points to spend</h4>
      <p>It is recommended to spend your points before clicking start game</p>
      <p>as some of their effects will only activate when a new level is started.</p>
      <button ng-click="zm.startGame();">Start Level {{zm.model.level}}</button>
    </div>
  </body>
</html>
